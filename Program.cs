using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Data;
using System.Data.SqlClient;
using System.Xml.Linq;
using System.IO;

namespace ConsoleApplication4
{
    public class Program
    {
        public static void Main()
        {
            SqlConnection sqlConn = new SqlConnection("server=10.23.129.107;database=CiticsMF;uid=fpread;pwd=1qaz2wsx");
            sqlConn.Open();
            SqlCommand sql = new SqlCommand();
            //按类型计算规模
            //with records (year_number, quarter_number, record_number)as                                                                                                                                                                                                                                                                                                                                                                                                         
            //(    select year_number                                                                                                                                                                                                                                                                                                                                                                                                                                             
            //     ,row_number() over (partition by year_number order by year_number) quarter_number                                                                                                                                                                                                                                                                                                                                                                              
            //     ,row_number() over (order by year_number) record_number                                                                                                                                                                                                                                                                                                                                                                                                        
            //     from (  select ntile(20) over (order by [object_id]) + 2009 year_number                                                                                                                                                                                                                                                                                                                                                                                        
            //       from (select top 200 object_id from sys.all_objects) t   ) t                                                                                                                                                                                                                                                                                                                                                                                                 
            //     where year_number <= year(GETDATE())                                                                                                                                                                                                                                                                                                                                                                                                                           
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //, t_date as                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //  ---get the quarter end date                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //  ---you can modify time in this table!                                                                                                                                                                                                                                                                                                                                                                                                                             
            //  select convert(varchar(8), dateadd(qq, record_number, '20130331'), 112) as end_date from records                                                                                                                                                                                                                                                                                                                                                                  
            //  where dateadd(qq, record_number, '20130331')<=GETDATE()                                                                                                                                                                                                                                                                                                                                                                                                           
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //, t_size1 as                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //( ---由于存在有的基金没有份额但是净值表中有数据的情况，对于份额表需要用左连接                                                                                                                                                                                                                                                                                                                                                                                       
            //  ---get the fund size of quarter end                                                                                                                                                                                                                                                                                                                                                                                                                               
            //  select d.end_date,f1_2000 as fund_id, a.f5_1002*b.F4_2000 size                                                                                                                                                                                                                                                                                                                                                                                                    
            //  from t_date d                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //  join citicsMF.dbo.MF_Table_2000 b                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //    on b.f3_2000 = (select MAX(f3_2000) from citicsMF.dbo.MF_Table_2000 bb where f3_2000<=d.end_date and bb.F1_2000=b.F1_2000 and bb.F4_2000 is not NULL)                                                                                                                                                                                                                                                                                                           
            //  left join citicsMF.dbo.MF_Table_1002 a                                                                                                                                                                                                                                                                                                                                                                                                                            
            //    on b.f1_2000=a.f1_1002 and a.f2_1002 =(select MAX(f2_1002) from citicsMF.dbo.MF_Table_1002 aa where F2_1002<=d.end_date and aa.F1_1002=a.F1_1002 and aa.F5_1002 is not NULL)                                                                                                                                                                                                                                                                                    
            //  )                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //, t_size as                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //---规则是选取2000表的最接近季末的总资产净值数据，若没有则用单位净值乘总份额                                                                                                                                                                                                                                                                                                                                                                                         
            //select end_date,fund_id                                                                                                                                                                                                                                                                                                                                                                                                                                             
            //  , case when F5_2000 is not NULL then F5_2000/100000000                                                                                                                                                                                                                                                                                                                                                                                                            
            //         else size/10000                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //    end size                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //from                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //select * from t_size1                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //left join [CiticsMF].[dbo].[MF_Table_2000] a                                                                                                                                                                                                                                                                                                                                                                                                                        
            //on a.F1_2000=t_size1.fund_id and a.F3_2000 =                                                                                                                                                                                                                                                                                                                                                                                                                        
            //(select max(f3_2000) from [CiticsMF].[dbo].[MF_Table_2000] b where b.f1_2000=a.f1_2000 and f3_2000>t_size1.end_date-299 and f3_2000<=t_size1.end_date)                                                                                                                                                                                                                                                                                                              
            //) t                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //, t_type as                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            // -- type format                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //  SELECT F1_1006 as typeid                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //  ,case when F2_1006 like N'%货币市场基金' then N'货币市场基金'                                                                                                                                                                                                                                                                                                                                                                                                     
            //        when F2_1006 like N'%QDII' then 'QDII'                                                                                                                                                                                                                                                                                                                                                                                                                      
            //        else F2_1006                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //   end typename                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //  FROM citicsMF.[dbo].[MF_Table_1006]                                                                                                                                                                                                                                                                                                                                                                                                                               
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //, tab_main as                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //---主表，去掉互联网E份额                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //SELECT F1_1000 as id, Object_Full_Name_1000 as name, F4_1000 as strdate, F5_1000 as enddate,                                                                                                                                                                                                                                                                                                                                                                        
            //substring(F10_1000,3,1) as prop, typename,Object_Name_1005 as comp_name                                                                                                                                                                                                                                                                                                                                                                                             
            //  FROM [CiticsMF].[dbo].[MF_Table_1000] a                                                                                                                                                                                                                                                                                                                                                                                                                           
            //  left join t_type                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //  on t_type.typeid=a.F3_1000                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //  left join [CiticsMF].[dbo].[MF_Table_1005] b                                                                                                                                                                                                                                                                                                                                                                                                                      
            //  on a.F7_1000=b.F5_1005                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //  where Object_Name_1000 not like '%E'                                                                                                                                                                                                                                                                                                                                                                                                                              
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //, tab_fenji as(                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //select id,name,strdate,enddate,typename,prop,comp_name,                                                                                                                                                                                                                                                                                                                                                                                                             
            //count(1) over(partition by name,strdate) rnum                                                                                                                                                                                                                                                                                                                                                                                                                       
            //from tab_main where prop in ('A','B','M')                                                                                                                                                                                                                                                                                                                                                                                                                           
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //, tab_fenji1 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //select id,name,strdate,enddate,N'债券分级基金' as typename,prop,comp_name                                                                                                                                                                                                                                                                                                                                                                                           
            //from tab_fenji                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //where rnum='2'                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //, tab_fenji2 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //select id,name,strdate,enddate,                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //case when typename like N'%债券%' or typename like N'待处理' or typename is NULL then N'债券分级基金'                                                                                                                                                                                                                                                                                                                                                               
            //     when typename like N'%股票%' or typename like N'%被动指数%' then N'股票分级基金'                                                                                                                                                                                                                                                                                                                                                                               
            //     when typename like N'%特定投向%' then N'股票分级基金'                                                                                                                                                                                                                                                                                                                                                                                                          
            //     when typename like '%QDII%' then N'QDII分级基金'                                                                                                                                                                                                                                                                                                                                                                                                               
            //     else typename                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //end typename,prop,comp_name                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //from tab_fenji                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //where rnum='3' and prop='M'                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //, tab_fenji3 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //select *,case when typename=N'股票分级基金' then 1                                                                                                                                                                                                                                                                                                                                                                                                                  
            //              when typename=N'债券分级基金' then 2                                                                                                                                                                                                                                                                                                                                                                                                                  
            //              when typename=N'QDII分级基金' then 3                                                                                                                                                                                                                                                                                                                                                                                                                  
            //              else 0                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //         end  typenum                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //from tab_fenji2                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //, tab_fenji4 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //---将子份额基金类别调整为重新归类的主份额类型                                                                                                                                                                                                                                                                                                                                                                                                                       
            //select a.id,a.name,a.strdate,a.enddate                                                                                                                                                                                                                                                                                                                                                                                                                              
            //      ,case when t.typenum=1 then N'股票分级基金'                                                                                                                                                                                                                                                                                                                                                                                                                   
            //            when t.typenum=2 then N'债券分级基金'                                                                                                                                                                                                                                                                                                                                                                                                                   
            //            when t.typenum=3 then N'QDII分级基金'                                                                                                                                                                                                                                                                                                                                                                                                                   
            //       else a.typename                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //       end typename,a.prop,a.comp_name                                                                                                                                                                                                                                                                                                                                                                                                                              
            //      from (select * from tab_fenji where rnum='3') a                                                                                                                                                                                                                                                                                                                                                                                                               
            //      left join tab_fenji3 t                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //      on t.name=a.name                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //, tab_fenji5 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //select * from tab_fenji1                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //union all                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //select id,name,strdate,enddate                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //      ,case when name=N'国投瑞银瑞福深证100指数分级证券投资基金' then N'股票分级基金'                                                                                                                                                                                                                                                                                                                                                                               
            //            else typename                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //            end typename,prop,comp_name                                                                                                                                                                                                                                                                                                                                                                                                                             
            //       from tab_fenji4                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //, tab_main1 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //---reclassified main table                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //select id,name,strdate,enddate,typename,comp_name,prop                                                                                                                                                                                                                                                                                                                                                                                                              
            //from tab_main                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //where prop not in ('A','B','M')                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //union all                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //select id,name,strdate,enddate,typename,comp_name,prop                                                                                                                                                                                                                                                                                                                                                                                                              
            //from tab_fenji5                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //, final1 as                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //select * from t_size                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //join tab_main1                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //on t_size.fund_id=tab_main1.id and (tab_main1.strdate<=t_size.end_date and (tab_main1.enddate>=t_size.end_date or tab_main1.enddate is NULL))                                                                                                                                                                                                                                                                                                                       
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //, final2 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //select end_date,fund_id                                                                                                                                                                                                                                                                                                                                                                                                                                             
            //      ,case when end_date>'20131231' and fund_id='S4787126' then 0                                                                                                                                                                                                                                                                                                                                                                                                  
            //            else size                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //            end size                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //      ,name,strdate,enddate,typename,comp_name,prop                                                                                                                                                                                                                                                                                                                                                                                                                 
            //      from final1                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //, final3 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //---做一个检验，对于每一个季度，若分级基金的M份额是A/B份额的规模和，则去掉M。否则保留M。                                                                                                                                                                                                                                                                                                                                                                             
            //select * from final2                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //where fund_id not in(                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //select fund_id from (                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //select *,SUM(size) over(partition by end_date,name) as size1                                                                                                                                                                                                                                                                                                                                                                                                        
            //from final2                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //) t                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //where t.size1/2=t.size and t.prop='M'                                                                                                                                                                                                                                                                                                                                                                                                                               
            //))                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //, final as                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //select distinct end_date,size,name,typename,comp_name from final3                                                                                                                                                                                                                                                                                                                                                                                                   
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //, tab_sumtype as                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //select end_date,typename,SUM(size) as size                                                                                                                                                                                                                                                                                                                                                                                                                          
            //from final                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //group by end_date,typename                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //)select end_date as N'季度末日期'                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //      ,max(case typename when N'普通股票型基金' then size end)N'普通股票型基金'                                                                                                                                                                                                                                                                                                                                                                                     
            //      ,max(case typename when N'被动股票指数型基金' then size end)N'被动股票指数型基金'                                                                                                                                                                                                                                                                                                                                                                             
            //      ,max(case typename when N'增强股票指数型基金' then size end)N'增强股票指数型基金'                                                                                                                                                                                                                                                                                                                                                                             
            //      ,max(case typename when N'特定投向型基金' then size end)N'特定投向型基金'                                                                                                                                                                                                                                                                                                                                                                                     
            //      ,max(case typename when N'股票分级基金' then size end)N'股票分级基金'                                                                                                                                                                                                                                                                                                                                                                                         
            //      ,max(case typename when N'债券分级基金' then size end)N'债券分级基金'                                                                                                                                                                                                                                                                                                                                                                                         
            //      ,max(case typename when N'普通混合型基金' then size end)N'普通混合型基金'                                                                                                                                                                                                                                                                                                                                                                                     
            //      ,max(case typename when N'激进混合型基金' then size end)N'激进混合型基金'                                                                                                                                                                                                                                                                                                                                                                                     
            //      ,max(case typename when N'保守混合型基金' then size end)N'保守混合型基金'                                                                                                                                                                                                                                                                                                                                                                                     
            //      ,max(case typename when N'普通债券型基金' then size end)N'普通债券型基金'                                                                                                                                                                                                                                                                                                                                                                                     
            //      ,max(case typename when N'激进债券型基金' then size end)N'激进债券型基金'                                                                                                                                                                                                                                                                                                                                                                                     
            //      ,max(case typename when N'债券指数型基金' then size end)N'债券指数型基金'                                                                                                                                                                                                                                                                                                                                                                                     
            //      ,max(case typename when N'保本基金' then size end)N'保本基金'                                                                                                                                                                                                                                                                                                                                                                                                 
            //      ,max(case typename when N'短债基金' then size end)N'短债基金'                                                                                                                                                                                                                                                                                                                                                                                                 
            //      ,max(case typename when N'纯债基金' then size end)N'纯债基金'                                                                                                                                                                                                                                                                                                                                                                                                 
            //      ,max(case typename when N'可转债基金' then size end)N'可转债基金'                                                                                                                                                                                                                                                                                                                                                                                             
            //      ,max(case typename when N'货币市场基金' then size end)N'货币市场基金'                                                                                                                                                                                                                                                                                                                                                                                         
            //      ,max(case typename when N'封闭式偏股型基金' then size end)N'封闭式偏股型基金'                                                                                                                                                                                                                                                                                                                                                                                 
            //      ,max(case typename when N'封闭式债券型基金' then size end)N'封闭式债券型基金'                                                                                                                                                                                                                                                                                                                                                                                 
            //      ,max(case typename when N'商品基金' then size end)N'商品基金'                                                                                                                                                                                                                                                                                                                                                                                                 
            //      ,max(case typename when N'QDII' then size end)N'QDII'                                                                                                                                                                                                                                                                                                                                                                                                         
            //      ,max(case typename when N'QDII分级基金' then size end)N'QDII分级基金'                                                                                                                                                                                                                                                                                                                                                                                         
            //      ,SUM(size)N'总计(单位：万元)'                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //from tab_sumtype                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //where typename <>N'待处理'                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //group by end_date                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //order by end_date desc                                                                                                                                                                                                                                                                                                                                                                                                                                              

            sql.CommandText = "with records (year_number, quarter_number, record_number)as  (    select year_number       ,row_number() over (partition by year_number order by year_number) quarter_number       ,row_number() over (order by year_number) record_number       from (  select ntile(20) over (order by [object_id]) + 2009 year_number         from (select top 200 object_id from sys.all_objects) t   ) t       where year_number <= year(GETDATE())  )  , t_date as  ( select convert(varchar(8), dateadd(qq, record_number, '20130331'), 112) as end_date from records   where dateadd(qq, record_number, '20130331')<=GETDATE() )   , t_size1 as  ( select d.end_date,f1_2000 as fund_id, a.f5_1002*b.F4_2000 size   from t_date d    join citicsMF.dbo.MF_Table_2000 b     on b.f3_2000 = (select MAX(f3_2000) from citicsMF.dbo.MF_Table_2000 bb where f3_2000<=d.end_date and bb.F1_2000=b.F1_2000 and bb.F4_2000 is not NULL)   left join citicsMF.dbo.MF_Table_1002 a      on b.f1_2000=a.f1_1002 and a.f2_1002 =(select MAX(f2_1002) from citicsMF.dbo.MF_Table_1002 aa where F2_1002<=d.end_date and aa.F1_1002=a.F1_1002 and aa.F5_1002 is not NULL)   ) , t_size as ( select end_date,fund_id   , case when F5_2000 is not NULL then F5_2000/100000000          else size/10000     end size from ( select * from t_size1 left join [CiticsMF].[dbo].[MF_Table_2000] a on a.F1_2000=t_size1.fund_id and a.F3_2000 =  (select max(f3_2000) from [CiticsMF].[dbo].[MF_Table_2000] b where b.f1_2000=a.f1_2000 and f3_2000>t_size1.end_date-299 and f3_2000<=t_size1.end_date) ) t ) , t_type as  ( SELECT F1_1006 as typeid    ,case when F2_1006 like N'%货币市场基金' then N'货币市场基金'          when F2_1006 like N'%QDII' then 'QDII'          else F2_1006     end typename    FROM citicsMF.[dbo].[MF_Table_1006]  ) , tab_main as  ( SELECT F1_1000 as id, Object_Full_Name_1000 as name, F4_1000 as strdate, F5_1000 as enddate, substring(F10_1000,3,1) as prop, typename,Object_Name_1005 as comp_name   FROM [CiticsMF].[dbo].[MF_Table_1000] a   left join t_type   on t_type.typeid=a.F3_1000   left join [CiticsMF].[dbo].[MF_Table_1005] b   on a.F7_1000=b.F5_1005   where Object_Name_1000 not like '%E' ) , tab_fenji as( select id,name,strdate,enddate,typename,prop,comp_name, count(1) over(partition by name,strdate) rnum  from tab_main where prop in ('A','B','M') ) , tab_fenji1 as( select id,name,strdate,enddate,N'债券分级基金' as typename,prop,comp_name  from tab_fenji where rnum='2' ) , tab_fenji2 as( select id,name,strdate,enddate, case when typename like N'%债券%' or typename like N'待处理' or typename is NULL then N'债券分级基金'       when typename like N'%股票%' or typename like N'%被动指数%' then N'股票分级基金'       when typename like N'%特定投向%' then N'股票分级基金'       when typename like '%QDII%' then N'QDII分级基金'      else typename end typename,prop,comp_name from tab_fenji where rnum='3' and prop='M'  ) , tab_fenji3 as( select *,case when typename=N'股票分级基金' then 1               when typename=N'债券分级基金' then 2               when typename=N'QDII分级基金' then 3               else 0          end  typenum from tab_fenji2 ) , tab_fenji4 as( select a.id,a.name,a.strdate,a.enddate       ,case when t.typenum=1 then N'股票分级基金'             when t.typenum=2 then N'债券分级基金'                when t.typenum=3 then N'QDII分级基金'        else a.typename        end typename,a.prop,a.comp_name       from (select * from tab_fenji where rnum='3') a       left join tab_fenji3 t       on t.name=a.name ) , tab_fenji5 as( select * from tab_fenji1 union all select id,name,strdate,enddate       ,case when name=N'国投瑞银瑞福深证100指数分级证券投资基金' then N'股票分级基金'             else typename             end typename,prop,comp_name         from tab_fenji4 ) , tab_main1 as( select id,name,strdate,enddate,typename,comp_name,prop from tab_main where prop not in ('A','B','M')  union all  select id,name,strdate,enddate,typename,comp_name,prop from tab_fenji5 ) , final1 as ( select * from t_size join tab_main1  on t_size.fund_id=tab_main1.id and (tab_main1.strdate<=t_size.end_date and (tab_main1.enddate>=t_size.end_date or tab_main1.enddate is NULL)) ) , final2 as( select end_date,fund_id       ,case when end_date>'20131231' and fund_id='S4787126' then 0             else size             end size       ,name,strdate,enddate,typename,comp_name,prop       from final1                           ) , final3 as( select * from final2  where fund_id not in( select fund_id from ( select *,SUM(size) over(partition by end_date,name) as size1 from final2 ) t  where t.size1/2=t.size and t.prop='M' )) , final as ( select distinct end_date,size,name,typename,comp_name from final3 ) , tab_sumtype as          ( select end_date,typename,SUM(size) as size from final group by end_date,typename )select end_date as N'季度末日期'       ,max(case typename when N'普通股票型基金' then size end)N'普通股票型基金'       ,max(case typename when N'被动股票指数型基金' then size end)N'被动股票指数型基金'       ,max(case typename when N'增强股票指数型基金' then size end)N'增强股票指数型基金'       ,max(case typename when N'特定投向型基金' then size end)N'特定投向型基金'       ,max(case typename when N'股票分级基金' then size end)N'股票分级基金'       ,max(case typename when N'债券分级基金' then size end)N'债券分级基金'       ,max(case typename when N'普通混合型基金' then size end)N'普通混合型基金'       ,max(case typename when N'激进混合型基金' then size end)N'激进混合型基金'       ,max(case typename when N'保守混合型基金' then size end)N'保守混合型基金'       ,max(case typename when N'普通债券型基金' then size end)N'普通债券型基金'       ,max(case typename when N'激进债券型基金' then size end)N'激进债券型基金'       ,max(case typename when N'债券指数型基金' then size end)N'债券指数型基金'       ,max(case typename when N'保本基金' then size end)N'保本基金'       ,max(case typename when N'短债基金' then size end)N'短债基金'       ,max(case typename when N'纯债基金' then size end)N'纯债基金'       ,max(case typename when N'可转债基金' then size end)N'可转债基金'       ,max(case typename when N'货币市场基金' then size end)N'货币市场基金'       ,max(case typename when N'封闭式偏股型基金' then size end)N'封闭式偏股型基金'       ,max(case typename when N'封闭式债券型基金' then size end)N'封闭式债券型基金'       ,max(case typename when N'商品基金' then size end)N'商品基金'       ,max(case typename when N'QDII' then size end)N'QDII'       ,max(case typename when N'QDII分级基金' then size end)N'QDII分级基金'       ,SUM(size)N'总计(单位：万元)' from tab_sumtype where typename <>N'待处理' group by end_date order by end_date desc";
            sql.CommandTimeout = 0;
            sql.Connection = sqlConn;
            SqlDataAdapter data1 = new SqlDataAdapter(sql);
            DataSet dt1 = new DataSet();
            data1.Fill(dt1);

            //按公司计算规模
            //declare @temp table                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //     end_date varchar(8)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //declare @code varchar(8000)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //insert into @temp                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //     end_date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //select convert(varchar(8), dateadd(qq, record_number, '20130331'), 112) as end_date from                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //(    select year_number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //     ,row_number() over (partition by year_number order by year_number) quarter_number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //     ,row_number() over (order by year_number) record_number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //     from (  select ntile(20) over (order by [object_id]) + 2009 year_number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //       from (select top 200 object_id from sys.all_objects) t   ) t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //     where year_number <= year(GETDATE())                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //     ) t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //     where dateadd(qq, record_number, '20130331')<=GETDATE()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //select @code='                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //with records (year_number, quarter_number, record_number)as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //(    select year_number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //     ,row_number() over (partition by year_number order by year_number) quarter_number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //     ,row_number() over (order by year_number) record_number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //     from (  select ntile(20) over (order by [object_id]) + 2009 year_number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //       from (select top 200 object_id from sys.all_objects) t   ) t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //     where year_number <= year(GETDATE())                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //, t_date as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //  ---get the quarter end date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //  ---you can modify time in this table!                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //  select convert(varchar(8), dateadd(qq, record_number, ''20130331''), 112) as end_date from records                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //  where dateadd(qq, record_number, ''20130331'')<=GETDATE()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //, t_size1 as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //( ---由于存在有的基金没有份额但是净值表中有数据的情况，对于份额表需要用左连接                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //  ---get the fund size of quarter end                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
            //  select d.end_date,f1_2000 as fund_id, a.f5_1002*b.F4_2000 size                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //  from t_date d                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //  join citicsMF.dbo.MF_Table_2000 b                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //    on b.f3_2000 = (select MAX(f3_2000) from citicsMF.dbo.MF_Table_2000 bb where f3_2000<=d.end_date and bb.F1_2000=b.F1_2000 and bb.F4_2000 is not NULL)                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //  left join citicsMF.dbo.MF_Table_1002 a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //    on b.f1_2000=a.f1_1002 and a.f2_1002 =(select MAX(f2_1002) from citicsMF.dbo.MF_Table_1002 aa where F2_1002<=d.end_date and aa.F1_1002=a.F1_1002 and aa.F5_1002 is not NULL)                                                                                                                                                                                                                                                                                                                                                                                                                  
            //  )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //, t_size as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //---规则是选取2000表的最接近季末的总资产净值数据，若没有则用单位净值乘总份额                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //select end_date,fund_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //  , case when F5_2000 is not NULL then F5_2000/100000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //         else size/10000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //    end size                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //from                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //select * from t_size1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
            //left join [CiticsMF].[dbo].[MF_Table_2000] a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //on a.F1_2000=t_size1.fund_id and a.F3_2000 =                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //(select max(f3_2000) from [CiticsMF].[dbo].[MF_Table_2000] b where b.f1_2000=a.f1_2000 and f3_2000>t_size1.end_date-299 and f3_2000<=t_size1.end_date)                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //) t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //, t_type as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            // -- type format                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //  SELECT F1_1006 as typeid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //  ,case when F2_1006 like N''%货币市场基金'' then N''货币市场基金''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //        when F2_1006 like N''%QDII'' then ''QDII''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //        else F2_1006                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //   end typename                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //  FROM citicsMF.[dbo].[MF_Table_1006]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //, tab_main as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //---主表，去掉互联网E份额                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //SELECT F1_1000 as id, Object_Full_Name_1000 as name, F4_1000 as strdate, F5_1000 as enddate,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //substring(F10_1000,3,1) as prop, typename,Object_Name_1005 as comp_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //  FROM [CiticsMF].[dbo].[MF_Table_1000] a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //  left join t_type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //  on t_type.typeid=a.F3_1000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //  left join [CiticsMF].[dbo].[MF_Table_1005] b                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //  on a.F7_1000=b.F5_1005                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //  where Object_Name_1000 not like ''%E''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //, tab_fenji as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //select id,name,strdate,enddate,typename,prop,comp_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //count(1) over(partition by name,strdate) rnum                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //from tab_main where prop in (''A'',''B'',''M'')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //, tab_fenji1 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //select id,name,strdate,enddate,N''债券分级基金'' as typename,prop,comp_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //from tab_fenji                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //where rnum=''2''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //, tab_fenji2 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //select id,name,strdate,enddate,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //case when typename like N''%债券%'' or typename like N''待处理'' or typename is NULL then N''债券分级基金''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //     when typename like N''%股票%'' or typename like N''%被动指数%'' then N''股票分级基金''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //     when typename like N''%特定投向%'' then N''股票分级基金''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //     when typename like ''%QDII%'' then N''QDII分级基金''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //     else typename                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //end typename,prop,comp_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //from tab_fenji                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //where rnum=''3'' and prop=''M''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //, tab_fenji3 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //select *,case when typename=N''股票分级基金'' then 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //              when typename=N''债券分级基金'' then 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //              when typename=N''QDII分级基金'' then 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //              else 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //         end  typenum                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
            //from tab_fenji2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //, tab_fenji4 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //---将子份额基金类别调整为重新归类的主份额类型                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //select a.id,a.name,a.strdate,a.enddate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //      ,case when t.typenum=1 then N''股票分级基金''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //            when t.typenum=2 then N''债券分级基金''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //            when t.typenum=3 then N''QDII分级基金''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //       else a.typename                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //       end typename,a.prop,a.comp_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //      from (select * from tab_fenji where rnum=''3'') a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //      left join tab_fenji3 t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //      on t.name=a.name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //, tab_fenji5 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //select * from tab_fenji1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //union all                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //select id,name,strdate,enddate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //      ,case when name=N''国投瑞银瑞福深证100指数分级证券投资基金'' then N''股票分级基金''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //            else typename                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //            end typename,prop,comp_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //       from tab_fenji4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //, tab_main1 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //---reclassified main table                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //select id,name,strdate,enddate,typename,comp_name,prop                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //from tab_main                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //where prop not in (''A'',''B'',''M'')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
            //union all                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //select id,name,strdate,enddate,typename,comp_name,prop                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //from tab_fenji5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //, final1 as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //select * from t_size                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //join tab_main1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //on t_size.fund_id=tab_main1.id and (tab_main1.strdate<=t_size.end_date and (tab_main1.enddate>=t_size.end_date or tab_main1.enddate is NULL))                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //, final2 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //select end_date,fund_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //      ,case when end_date>''20131231'' and fund_id=''S4787126'' then 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //            else size                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
            //            end size                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //      ,name,strdate,enddate,typename,comp_name,prop                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //      from final1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //, final3 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //---做一个检验，对于每一个季度，若分级基金的M份额是A/B份额的规模和，则去掉M。否则保留M。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //select * from final2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //where fund_id not in(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
            //select fund_id from (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
            //select *,SUM(size) over(partition by end_date,name) as size1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //from final2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //) t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //where t.size1/2=t.size and t.prop=''M''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //, final as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //select distinct end_date,size,name,typename,comp_name from final3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //, tab_sumcomp as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //select end_date,comp_name,sum(size) as size                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //from final                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //group by end_date,comp_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //,name as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //select distinct comp_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //from tab_sumcomp                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //where comp_name is not NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //select name.comp_name'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //select @code=@code+',size_'+end_date+',rank_'+end_date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //       from (select end_date from @temp) t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //select @code=@code+' from name '                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //select @code=@code+'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //left join (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //select comp_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //      ,size as size_'+end_date+'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //      ,DENSE_RANK() over (order by size DESC) as rank_'+end_date+'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //from tab_sumcomp                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //where comp_name is not NULL and end_date='''+end_date+'''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //) s'+end_date+'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //on name.comp_name=s'+end_date+'.comp_name'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //       from (select end_date from @temp) t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //execute (@code)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   

            sql.CommandText = "declare @temp table (      end_date varchar(8) ) declare @code varchar(8000) insert into @temp (      end_date ) select convert(varchar(8), dateadd(qq, record_number, '20130331'), 112) as end_date from (    select year_number       ,row_number() over (partition by year_number order by year_number) quarter_number       ,row_number() over (order by year_number) record_number       from (  select ntile(20) over (order by [object_id]) + 2009 year_number         from (select top 200 object_id from sys.all_objects) t   ) t       where year_number <= year(GETDATE())      ) t      where dateadd(qq, record_number, '20130331')<=GETDATE()  select @code=' with records (year_number, quarter_number, record_number)as  (    select year_number       ,row_number() over (partition by year_number order by year_number) quarter_number       ,row_number() over (order by year_number) record_number       from (  select ntile(20) over (order by [object_id]) + 2009 year_number         from (select top 200 object_id from sys.all_objects) t   ) t       where year_number <= year(GETDATE())  )  , t_date as  (    select convert(varchar(8), dateadd(qq, record_number, ''20130331''), 112) as end_date from records   where dateadd(qq, record_number, ''20130331'')<=GETDATE() )   , t_size1 as  ( select d.end_date,f1_2000 as fund_id, a.f5_1002*b.F4_2000 size   from t_date d    join citicsMF.dbo.MF_Table_2000 b     on b.f3_2000 = (select MAX(f3_2000) from citicsMF.dbo.MF_Table_2000 bb where f3_2000<=d.end_date and bb.F1_2000=b.F1_2000 and bb.F4_2000 is not NULL)   left join citicsMF.dbo.MF_Table_1002 a      on b.f1_2000=a.f1_1002 and a.f2_1002 =(select MAX(f2_1002) from citicsMF.dbo.MF_Table_1002 aa where F2_1002<=d.end_date and aa.F1_1002=a.F1_1002 and aa.F5_1002 is not NULL)   ) , t_size as ( select end_date,fund_id   , case when F5_2000 is not NULL then F5_2000/100000000          else size/10000     end size from ( select * from t_size1 left join [CiticsMF].[dbo].[MF_Table_2000] a on a.F1_2000=t_size1.fund_id and a.F3_2000 =  (select max(f3_2000) from [CiticsMF].[dbo].[MF_Table_2000] b where b.f1_2000=a.f1_2000 and f3_2000>t_size1.end_date-299 and f3_2000<=t_size1.end_date) ) t ) , t_type as  (    SELECT F1_1006 as typeid    ,case when F2_1006 like N''%货币市场基金'' then N''货币市场基金''          when F2_1006 like N''%QDII'' then ''QDII''          else F2_1006     end typename    FROM citicsMF.[dbo].[MF_Table_1006]  ) , tab_main as  ( SELECT F1_1000 as id, Object_Full_Name_1000 as name, F4_1000 as strdate, F5_1000 as enddate, substring(F10_1000,3,1) as prop, typename,Object_Name_1005 as comp_name   FROM [CiticsMF].[dbo].[MF_Table_1000] a   left join t_type   on t_type.typeid=a.F3_1000   left join [CiticsMF].[dbo].[MF_Table_1005] b   on a.F7_1000=b.F5_1005   where Object_Name_1000 not like ''%E'' ) , tab_fenji as( select id,name,strdate,enddate,typename,prop,comp_name, count(1) over(partition by name,strdate) rnum  from tab_main where prop in (''A'',''B'',''M'') ) , tab_fenji1 as( select id,name,strdate,enddate,N''债券分级基金'' as typename,prop,comp_name  from tab_fenji where rnum=''2'' ) , tab_fenji2 as( select id,name,strdate,enddate, case when typename like N''%债券%'' or typename like N''待处理'' or typename is NULL then N''债券分级基金''       when typename like N''%股票%'' or typename like N''%被动指数%'' then N''股票分级基金''       when typename like N''%特定投向%'' then N''股票分级基金''       when typename like ''%QDII%'' then N''QDII分级基金''      else typename end typename,prop,comp_name from tab_fenji where rnum=''3'' and prop=''M''  ) , tab_fenji3 as( select *,case when typename=N''股票分级基金'' then 1               when typename=N''债券分级基金'' then 2               when typename=N''QDII分级基金'' then 3               else 0          end  typenum from tab_fenji2 ) , tab_fenji4 as( select a.id,a.name,a.strdate,a.enddate       ,case when t.typenum=1 then N''股票分级基金''             when t.typenum=2 then N''债券分级基金''                when t.typenum=3 then N''QDII分级基金''        else a.typename        end typename,a.prop,a.comp_name       from (select * from tab_fenji where rnum=''3'') a       left join tab_fenji3 t       on t.name=a.name ) , tab_fenji5 as( select * from tab_fenji1 union all select id,name,strdate,enddate       ,case when name=N''国投瑞银瑞福深证100指数分级证券投资基金'' then N''股票分级基金''             else typename             end typename,prop,comp_name         from tab_fenji4 ) , tab_main1 as( select id,name,strdate,enddate,typename,comp_name,prop from tab_main where prop not in (''A'',''B'',''M'')  union all  select id,name,strdate,enddate,typename,comp_name,prop from tab_fenji5 ) , final1 as ( select * from t_size join tab_main1  on t_size.fund_id=tab_main1.id and (tab_main1.strdate<=t_size.end_date and (tab_main1.enddate>=t_size.end_date or tab_main1.enddate is NULL)) ) , final2 as( select end_date,fund_id       ,case when end_date>''20131231'' and fund_id=''S4787126'' then 0             else size             end size       ,name,strdate,enddate,typename,comp_name,prop       from final1                           ) , final3 as( select * from final2  where fund_id not in( select fund_id from ( select *,SUM(size) over(partition by end_date,name) as size1 from final2 ) t  where t.size1/2=t.size and t.prop=''M'' )) , final as ( select distinct end_date,size,name,typename,comp_name from final3 ) , tab_sumcomp as ( select end_date,comp_name,sum(size) as size  from final group by end_date,comp_name ) ,name as  ( select distinct comp_name  from tab_sumcomp where comp_name is not NULL )  select name.comp_name' select @code=@code+',size_'+end_date+',rank_'+end_date        from (select end_date from @temp) t select @code=@code+' from name ' select @code=@code+' left join ( select comp_name       ,size as size_'+end_date+'       ,DENSE_RANK() over (order by size DESC) as rank_'+end_date+' from tab_sumcomp where comp_name is not NULL and end_date='''+end_date+''' ) s'+end_date+' on name.comp_name=s'+end_date+'.comp_name'        from (select end_date from @temp) t execute (@code) ";
            sql.CommandTimeout = 0;
            sql.Connection = sqlConn;
            SqlDataAdapter data2 = new SqlDataAdapter(sql);
            DataSet dt2 = new DataSet();
            data2.Fill(dt2);

            //明细表
            //with records (year_number, quarter_number, record_number)as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //(    select year_number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //     ,row_number() over (partition by year_number order by year_number) quarter_number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //     ,row_number() over (order by year_number) record_number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //     from (  select ntile(20) over (order by [object_id]) + 2009 year_number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //       from (select top 200 object_id from sys.all_objects) t   ) t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //     where year_number <= year(GETDATE())                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //, t_date as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //  ---get the quarter end date                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //  ---you can modify time in this table!                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //  select convert(varchar(8), dateadd(qq, record_number, '20130331'), 112) as end_date from records                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //  where dateadd(qq, record_number, '20130331')<=GETDATE()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //, t_size1 as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //( ---由于存在有的基金没有份额但是净值表中有数据的情况，对于份额表需要用左连接                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //  ---get the fund size of quarter end                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //  select d.end_date,f1_2000 as fund_id, a.f5_1002*b.F4_2000 size                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //  from t_date d                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //  join citicsMF.dbo.MF_Table_2000 b                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //    on b.f3_2000 = (select MAX(f3_2000) from citicsMF.dbo.MF_Table_2000 bb where f3_2000<=d.end_date and bb.F1_2000=b.F1_2000 and bb.F4_2000 is not NULL)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //  left join citicsMF.dbo.MF_Table_1002 a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //    on b.f1_2000=a.f1_1002 and a.f2_1002 =(select MAX(f2_1002) from citicsMF.dbo.MF_Table_1002 aa where F2_1002<=d.end_date and aa.F1_1002=a.F1_1002 and aa.F5_1002 is not NULL)                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //  )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //, t_size as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //---规则是选取2000表的最接近季末的总资产净值数据，若没有则用单位净值乘总份额                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //select end_date,fund_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //  , case when F5_2000 is not NULL then F5_2000/100000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //         else size/10000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //    end size                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //from                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //select * from t_size1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //left join [CiticsMF].[dbo].[MF_Table_2000] a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //on a.F1_2000=t_size1.fund_id and a.F3_2000 =                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //(select max(f3_2000) from [CiticsMF].[dbo].[MF_Table_2000] b where b.f1_2000=a.f1_2000 and f3_2000>t_size1.end_date-299 and f3_2000<=t_size1.end_date)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //) t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //, t_type as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            // -- type format                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //  SELECT F1_1006 as typeid                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
            //  ,case when F2_1006 like N'%货币市场基金' then N'货币市场基金'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //        when F2_1006 like N'%QDII' then 'QDII'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //        else F2_1006                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //   end typename                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //  FROM citicsMF.[dbo].[MF_Table_1006]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //, tab_main as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //---主表，去掉互联网E份额                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //SELECT F1_1000 as id, Object_Full_Name_1000 as name, F4_1000 as strdate, F5_1000 as enddate,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //substring(F10_1000,3,1) as prop, typename,Object_Name_1005 as comp_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //  FROM [CiticsMF].[dbo].[MF_Table_1000] a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //  left join t_type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //  on t_type.typeid=a.F3_1000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //  left join [CiticsMF].[dbo].[MF_Table_1005] b                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //  on a.F7_1000=b.F5_1005                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //  where Object_Name_1000 not like '%E'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //, tab_fenji as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //select id,name,strdate,enddate,typename,prop,comp_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //count(1) over(partition by name,strdate) rnum                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //from tab_main where prop in ('A','B','M')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //, tab_fenji1 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //select id,name,strdate,enddate,N'债券分级基金' as typename,prop,comp_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //from tab_fenji                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //where rnum='2'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //, tab_fenji2 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //select id,name,strdate,enddate,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //case when typename like N'%债券%' or typename like N'待处理' or typename is NULL then N'债券分级基金'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //     when typename like N'%股票%' or typename like N'%被动指数%' then N'股票分级基金'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //     when typename like N'%特定投向%' then N'股票分级基金'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
            //     when typename like '%QDII%' then N'QDII分级基金'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //     else typename                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //end typename,prop,comp_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //from tab_fenji                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //where rnum='3' and prop='M'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //, tab_fenji3 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //select *,case when typename=N'股票分级基金' then 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //              when typename=N'债券分级基金' then 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //              when typename=N'QDII分级基金' then 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //              else 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //         end  typenum                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //from tab_fenji2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //, tab_fenji4 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //---将子份额基金类别调整为重新归类的主份额类型                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //select a.id,a.name,a.strdate,a.enddate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //      ,case when t.typenum=1 then N'股票分级基金'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //            when t.typenum=2 then N'债券分级基金'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //            when t.typenum=3 then N'QDII分级基金'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //       else a.typename                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //       end typename,a.prop,a.comp_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //      from (select * from tab_fenji where rnum='3') a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //      left join tab_fenji3 t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //      on t.name=a.name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //, tab_fenji5 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            //select * from tab_fenji1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            //union all                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //select id,name,strdate,enddate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //      ,case when name=N'国投瑞银瑞福深证100指数分级证券投资基金' then N'股票分级基金'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //            else typename                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //            end typename,prop,comp_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //       from tab_fenji4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //, tab_main1 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //---reclassified main table                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
            //select id,name,strdate,enddate,typename,comp_name,prop                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //from tab_main                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //where prop not in ('A','B','M')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //union all                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            //select id,name,strdate,enddate,typename,comp_name,prop                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            //from tab_fenji5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //, final1 as                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //select * from t_size                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //join tab_main1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            //on t_size.fund_id=tab_main1.id and (tab_main1.strdate<=t_size.end_date and (tab_main1.enddate>=t_size.end_date or tab_main1.enddate is NULL))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //, final2 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //select end_date,fund_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //      ,case when end_date>'20131231' and fund_id='S4787126' then 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //            else size                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //            end size                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //      ,name,strdate,enddate,typename,comp_name,prop                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //      from final1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //, final3 as(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //---做一个检验，对于每一个季度，若分级基金的M份额是A/B份额的规模和，则去掉M。否则保留M。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            //select * from final2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            //where fund_id not in(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //select fund_id from (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //select *,SUM(size) over(partition by end_date,name) as size1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            //from final2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
            //) t                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
            //where t.size1/2=t.size and t.prop='M'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            //))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            //select distinct end_date,size,name,typename,comp_name from final3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
            //order by end_date,name desc                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            

            sql.CommandText = "with records (year_number, quarter_number, record_number)as  (    select year_number       ,row_number() over (partition by year_number order by year_number) quarter_number       ,row_number() over (order by year_number) record_number       from (  select ntile(20) over (order by [object_id]) + 2009 year_number         from (select top 200 object_id from sys.all_objects) t   ) t       where year_number <= year(GETDATE())  )  , t_date as  (    select convert(varchar(8), dateadd(qq, record_number, '20130331'), 112) as end_date from records   where dateadd(qq, record_number, '20130331')<=GETDATE() )   , t_size1 as  ( select d.end_date,f1_2000 as fund_id, a.f5_1002*b.F4_2000 size   from t_date d    join citicsMF.dbo.MF_Table_2000 b     on b.f3_2000 = (select MAX(f3_2000) from citicsMF.dbo.MF_Table_2000 bb where f3_2000<=d.end_date and bb.F1_2000=b.F1_2000 and bb.F4_2000 is not NULL)   left join citicsMF.dbo.MF_Table_1002 a      on b.f1_2000=a.f1_1002 and a.f2_1002 =(select MAX(f2_1002) from citicsMF.dbo.MF_Table_1002 aa where F2_1002<=d.end_date and aa.F1_1002=a.F1_1002 and aa.F5_1002 is not NULL)   ) , t_size as ( select end_date,fund_id   , case when F5_2000 is not NULL then F5_2000/100000000          else size/10000     end size from ( select * from t_size1 left join [CiticsMF].[dbo].[MF_Table_2000] a on a.F1_2000=t_size1.fund_id and a.F3_2000 =  (select max(f3_2000) from [CiticsMF].[dbo].[MF_Table_2000] b where b.f1_2000=a.f1_2000 and f3_2000>t_size1.end_date-299 and f3_2000<=t_size1.end_date) ) t ) , t_type as  (     SELECT F1_1006 as typeid    ,case when F2_1006 like N'%货币市场基金' then N'货币市场基金'          when F2_1006 like N'%QDII' then 'QDII'          else F2_1006     end typename    FROM citicsMF.[dbo].[MF_Table_1006]  ) , tab_main as  ( SELECT F1_1000 as id, Object_Full_Name_1000 as name, F4_1000 as strdate, F5_1000 as enddate, substring(F10_1000,3,1) as prop, typename,Object_Name_1005 as comp_name   FROM [CiticsMF].[dbo].[MF_Table_1000] a   left join t_type   on t_type.typeid=a.F3_1000   left join [CiticsMF].[dbo].[MF_Table_1005] b   on a.F7_1000=b.F5_1005   where Object_Name_1000 not like '%E' ) , tab_fenji as( select id,name,strdate,enddate,typename,prop,comp_name, count(1) over(partition by name,strdate) rnum  from tab_main where prop in ('A','B','M') ) , tab_fenji1 as( select id,name,strdate,enddate,N'债券分级基金' as typename,prop,comp_name  from tab_fenji where rnum='2' ) , tab_fenji2 as( select id,name,strdate,enddate, case when typename like N'%债券%' or typename like N'待处理' or typename is NULL then N'债券分级基金'       when typename like N'%股票%' or typename like N'%被动指数%' then N'股票分级基金'       when typename like N'%特定投向%' then N'股票分级基金'       when typename like '%QDII%' then N'QDII分级基金'      else typename end typename,prop,comp_name from tab_fenji where rnum='3' and prop='M'  ) , tab_fenji3 as( select *,case when typename=N'股票分级基金' then 1               when typename=N'债券分级基金' then 2               when typename=N'QDII分级基金' then 3               else 0          end  typenum from tab_fenji2 ) , tab_fenji4 as( select a.id,a.name,a.strdate,a.enddate       ,case when t.typenum=1 then N'股票分级基金'             when t.typenum=2 then N'债券分级基金'                when t.typenum=3 then N'QDII分级基金'        else a.typename        end typename,a.prop,a.comp_name       from (select * from tab_fenji where rnum='3') a       left join tab_fenji3 t       on t.name=a.name ) , tab_fenji5 as( select * from tab_fenji1 union all select id,name,strdate,enddate       ,case when name=N'国投瑞银瑞福深证100指数分级证券投资基金' then N'股票分级基金'             else typename             end typename,prop,comp_name         from tab_fenji4 ) , tab_main1 as(select id,name,strdate,enddate,typename,comp_name,prop from tab_main where prop not in ('A','B','M')  union all  select id,name,strdate,enddate,typename,comp_name,prop from tab_fenji5 ) , final1 as ( select * from t_size join tab_main1  on t_size.fund_id=tab_main1.id and (tab_main1.strdate<=t_size.end_date and (tab_main1.enddate>=t_size.end_date or tab_main1.enddate is NULL)) ) , final2 as( select end_date,fund_id       ,case when end_date>'20131231' and fund_id='S4787126' then 0             else size             end size       ,name,strdate,enddate,typename,comp_name,prop       from final1                           ) , final3 as( select * from final2  where fund_id not in( select fund_id from ( select *,SUM(size) over(partition by end_date,name) as size1 from final2 ) t  where t.size1/2=t.size and t.prop='M' )) select distinct end_date,size,name,typename,comp_name from final3 order by end_date,name desc ";
            sql.CommandTimeout = 0;
            sql.Connection = sqlConn;
            SqlDataAdapter data3 = new SqlDataAdapter(sql);
            DataSet dt3 = new DataSet();
            data3.Fill(dt3);
            DatasetToExcel(dt1, dt2, dt3);
            sqlConn.Close();
        }
        static public bool DatasetToExcel(DataSet dt1, DataSet dt2, DataSet dt3)
        {
            DataTable dataTable1 = dt1.Tables[0];
            DataTable dataTable2 = dt2.Tables[0];
            DataTable dataTable3 = dt3.Tables[0];
            int rowIndex = 1;
            int colIndex = 0;
            Microsoft.Office.Interop.Excel.ApplicationClass xlsApp = new Microsoft.Office.Interop.Excel.ApplicationClass();
            Microsoft.Office.Interop.Excel.Workbooks books = (Microsoft.Office.Interop.Excel.Workbooks)xlsApp.Workbooks;
            Microsoft.Office.Interop.Excel.Workbook book = (Microsoft.Office.Interop.Excel.Workbook)books.Add();
            Microsoft.Office.Interop.Excel.Worksheet sheet1 = (Microsoft.Office.Interop.Excel.Worksheet)book.Sheets[1];
            sheet1.Name = "各类型规模";
            xlsApp.Visible = true;
            foreach (DataColumn col in dataTable1.Columns)
            {
                colIndex++;
                sheet1.Cells[1, colIndex] = col.ColumnName;
            }

            foreach (DataRow row in dataTable1.Rows)
            {
                rowIndex++;
                colIndex = 0;
                foreach (DataColumn col in dataTable1.Columns)
                {
                    colIndex++;
                    sheet1.Cells[rowIndex, colIndex] = row[col.ColumnName];
                }
            }
            Microsoft.Office.Interop.Excel.Worksheet sheet2 = (Microsoft.Office.Interop.Excel.Worksheet)book.Sheets[2];
            sheet2.Name = "各基金公司规模";
            rowIndex = 1;
            colIndex = 0;
            foreach (DataColumn col in dataTable2.Columns)
            {
                colIndex++;
                sheet2.Cells[1, colIndex] = col.ColumnName;
            }

            foreach (DataRow row in dataTable2.Rows)
            {
                rowIndex++;
                colIndex = 0;
                foreach (DataColumn col in dataTable2.Columns)
                {
                    colIndex++;
                    sheet2.Cells[rowIndex, colIndex] = row[col.ColumnName];
                }
            }
            try
            {
                Microsoft.Office.Interop.Excel.Worksheet sheet3 = (Microsoft.Office.Interop.Excel.Worksheet)book.Sheets[3];
                sheet3.Name = "明细表";
                rowIndex = 1;
                colIndex = 0;
                foreach (DataColumn col in dataTable3.Columns)
                {
                    colIndex++;
                    sheet3.Cells[1, colIndex] = col.ColumnName;
                }
                int rowCount = dataTable3.Rows.Count;
                int colCount = dataTable3.Columns.Count;
                object[,] dataArrray = new object[rowCount, colCount];
                for (int i = 0; i < rowCount; i++)
                {
                    for (int j = 0; j < colCount; j++)
                        dataArrray[i, j] = dataTable3.Rows[i][j];
                }
                Microsoft.Office.Interop.Excel.Range range = sheet3.Range[sheet3.Cells[2, 1],
                sheet3.Cells[1+rowCount,colCount]];
                range.Value = dataArrray;
            }
            catch (Exception ex)
            {
                return false;
            }
            return true;

        }
    }
}
